
---
title: "Task 4: Uncovering Associations between Weather and Flight Operations"
author: "GuoJun"
format: html
---

# Task 4: Uncovering Associations between Weather and Flight Operations

1. How many combinations of origin airport and time_hour are present in the flights table but absent from the weather table? Provide your answer in the form of a table with one row and one column.

```{sql}
#| connection: con


--3.5 

SELECT COUNT(*) AS combinations_absent
FROM (
    SELECT DISTINCT f.origin, f.time_hour
    FROM flights f
    LEFT JOIN weather w ON f.origin = w.origin AND f.time_hour = w.time_hour
    WHERE w.origin IS NULL
) AS absent_combinations; 
```
```{sql}
#| connection: con


--4o

SELECT COUNT(*) AS missing_combinations
FROM (
    SELECT DISTINCT origin, time_hour
    FROM flights
) AS f
LEFT JOIN (
    SELECT DISTINCT origin, time_hour
    FROM weather
) AS w
ON f.origin = w.origin AND f.time_hour = w.time_hour
WHERE w.origin IS NULL AND w.time_hour IS NULL;


```


2. What is the percentage of on-time departures from each of New York City’s main airports under dry conditions (i.e., precip = 0) and under wet conditions? Include columns for the following attributes:

  Three-letter airport code

  Airport name
  
  is_dry: Boolean values indicating zero precipitation.

  Percentage of on-time departures, rounded to two decimal places

First, sort the results alphabetically by the three-letter airport code and, then, by the presence of precipitation.



```{sql}
#| connection: con

--3.5

WITH on_time_departures AS (
    SELECT
        f.origin AS airport_code,
        a.name AS airport_name,
        w.precip = 0 AS is_dry,
        SUM(CASE WHEN f.dep_delay <= 0 THEN 1 ELSE 0 END) * 100.0 / COUNT(*) AS on_time_percentage
    FROM
        flights f
    JOIN
        airports a ON f.origin = a.faa
    JOIN
        weather w ON f.origin = w.origin AND f.year = w.year AND f.month = w.month AND f.day = w.day
    WHERE
        f.dep_delay IS NOT NULL
    GROUP BY
        f.origin, a.name, w.precip
)
SELECT
    airport_code,
    airport_name,
    is_dry,
    ROUND(on_time_percentage, 2) AS on_time_percentage
FROM
    on_time_departures
ORDER BY
    airport_code,
    is_dry;

```

```{sql}
#| connection: con


--4o

WITH on_time_departures AS (
    SELECT
        f.origin AS airport_code,
        a.name AS airport_name,
        w.precip = 0 AS is_dry,
        COUNT(*) FILTER (WHERE f.dep_delay <= 0) * 100.0 / COUNT(*) AS on_time_percentage
    FROM flights f
    JOIN weather w ON f.origin = w.origin AND f.time_hour = w.time_hour
    JOIN airports a ON f.origin = a.faa
    GROUP BY f.origin, a.name, is_dry
)
SELECT 
    airport_code,
    airport_name,
    is_dry,
    ROUND(on_time_percentage, 2) AS on_time_percentage
FROM on_time_departures
ORDER BY airport_code, is_dry;


```

3. How do New York City’s main airports rank in terms of mean departure delay when the visibility was less than one mile? Include columns for the following attributes:

  Three-letter airport code

  Airport name

  Mean departure delay in minutes, rounded to two decimal places
  
  Rank

Sort the results first by rank (starting with the smallest delay) and, then, alphabetically by the three-letter airport code. 

```{sql}
#| connection: con

--3.5

WITH visibility_delays AS (
    SELECT
        f.origin AS airport_code,
        a.name AS airport_name,
        ROUND(AVG(f.dep_delay), 2) AS mean_dep_delay,
        RANK() OVER (ORDER BY AVG(f.dep_delay)) AS rank
    FROM
        flights f
    JOIN
        airports a ON f.origin = a.faa
    JOIN
        weather w ON f.origin = w.origin AND f.year = w.year AND f.month = w.month AND f.day = w.day
    WHERE
        w.visib < 1
    GROUP BY
        f.origin, a.name
)
SELECT
    airport_code,
    airport_name,
    mean_dep_delay,
    rank
FROM
    visibility_delays
ORDER BY
    rank,
    airport_code;

```

```{sql}
#| connection: con

--4o
WITH visibility_delays AS (
    SELECT
        f.origin AS airport_code,
        a.name AS airport_name,
        AVG(f.dep_delay) AS mean_departure_delay
    FROM flights f
    JOIN weather w ON f.origin = w.origin AND f.time_hour = w.time_hour
    JOIN airports a ON f.origin = a.faa
    WHERE w.visib < 1
    GROUP BY f.origin, a.name
)
SELECT
    airport_code,
    airport_name,
    ROUND(mean_departure_delay, 2) AS mean_departure_delay,
    RANK() OVER (ORDER BY mean_departure_delay) AS rank
FROM visibility_delays
ORDER BY rank, airport_code;
```


4. What is the correlation coefficient between the mean temperature of the day and the mean departure delay on that day? Round the value to two decimal places. Provide the answer in the form of a table with one row and one column. Hint: calculate the AVG() of temperature for each day in 2013, and then the AVG() of departure delay for each day in 2013. After that, calculate the CORR() between these two sequences (of length 365 or less). Remember to INNER JOIN flights and weather.


```{sql}
#| connection: con

--3.5

SELECT ROUND(CORR(avg_temp, avg_dep_delay)::numeric, 2) AS correlation_coefficient
FROM (
    SELECT
        AVG(w.temp) AS avg_temp,
        AVG(f.dep_delay) AS avg_dep_delay
    FROM
        flights f
    INNER JOIN
        weather w ON f.origin = w.origin AND f.year = w.year AND f.month = w.month AND f.day = w.day
    WHERE
        f.year = 2013
    GROUP BY
        f.year, f.month, f.day
) AS daily_means;



```


```{sql}
#| connection: con


--4o
WITH daily_averages AS (
    SELECT
        w.year,
        w.month,
        w.day,
        AVG(w.temp) AS avg_temp,
        AVG(f.dep_delay) AS avg_dep_delay
    FROM weather w
    INNER JOIN flights f ON w.origin = f.origin AND w.year = f.year AND w.month = f.month AND w.day = f.day
    WHERE w.year = 2013 AND f.year = 2013
    GROUP BY w.year, w.month, w.day
)
SELECT
    ROUND(CAST(CORR(avg_temp, avg_dep_delay) AS numeric), 2) AS correlation_coefficient
FROM daily_averages;


```

5. Burlington, Vermont, lies almost exactly to the north of New York City. Is the mean flight time to Burlington International Airport (BTV) shorter when the wind blows from the south (between 135 and 225 degrees) compared to when it blows from the north (between 0 and 45 degrees as well as between 315 and 360 degrees)? Provide your answer in the form of a table with one row each for north and south winds, and two columns, named wind_direction and mean_air_time. Hint: CASE expression.


```{sql}
#| connection: con

--3.5

SELECT
    wind_direction,
    AVG(air_time) AS mean_air_time
FROM (
    SELECT
        CASE
            WHEN w.wind_dir BETWEEN 135 AND 225 THEN 'South'
            ELSE 'North'
        END AS wind_direction,
        f.air_time
    FROM
        flights f
    JOIN
        weather w ON f.origin = w.origin AND f.year = w.year AND f.month = w.month AND f.day = w.day
    WHERE
        f.dest = 'BTV'
) AS flight_wind_direction
GROUP BY
    wind_direction;

```

```{sql}
#| connection: con


--4o

WITH categorized_winds AS (
    SELECT
        f.flight,
        CASE
            WHEN (w.wind_dir BETWEEN 135 AND 225) THEN 'south'
            WHEN (w.wind_dir BETWEEN 0 AND 45 OR w.wind_dir BETWEEN 315 AND 360) THEN 'north'
            ELSE 'other'
        END AS wind_direction,
        f.air_time
    FROM flights f
    INNER JOIN weather w ON f.origin = w.origin AND f.time_hour = w.time_hour
    WHERE f.dest = 'BTV' AND f.year = 2013
)
SELECT
    wind_direction,
    ROUND(AVG(air_time), 2) AS mean_air_time
FROM categorized_winds
WHERE wind_direction IN ('north', 'south')
GROUP BY wind_direction
ORDER BY wind_direction;


```